# AICAクライアント外部仕様書

## 概要
AICAクライアントはElectronで開発されたWindowsデスクトップアプリであり、コーチングセッションの進行を支援する。リアルタイム音声認識、AIとの対話、セッション記録、報告書生成を一体的に提供する。

## 利用者
- **コーチ**: アプリの主な利用者。ユーザー情報やクライアント情報を管理し、セッションを実施する。
- **クライアント**: コーチングを受ける参加者。コーチがデータを管理し、セッション要約を受け取る。

## 起動シーケンス
1. 起動時にGPUを無効化し、互換性を確保する。
2. メインウィンドウ (`ui-smpl.html`) を生成する。
3. Electronの`userData`ディレクトリに`user_client_data.xml`が存在しない場合は初期化する。
4. 少し待機後、選択された音声認識サービス（Azure / AWS / AmiVoice）の実行ファイル`LiveTranscriptApp_<service>.exe`を起動する。

## 音声認識
- 音声認識アプリは子プロセスとして起動し、開始・停止状態をレンダラープロセスへ通知する。
- 文字起こし結果はローカルWebSocketサーバー`ws://localhost:8181/ws/`から受信し、画面に反映される。

## データ管理
- ユーザー・クライアント・セッション情報は`user_client_data.xml`に保存される。
- セッションごとに個別のXMLファイルを`clientdata/`配下に作成し、読み込みや削除が可能。
- `common.js`にはXMLの読み書き、ユーザー情報更新、クライアント選択、セッション履歴管理などの関数を提供する。

## メイン画面 (`ui-smpl.html`)
- リアルタイム文字起こしと自動生成された要約を表示。
- 会話内容をもとに提案質問とAIチャットを提示し、自由入力による質問送信も可能。
- クライアント選択で新規セッションを開始し、記録は自動保存される。
- 画面下部のボタンから以下へ遷移：
  - **マイページ** (`renew_userdata.html`): コーチ情報の編集。
  - **クライアントデータ編集** (`renew_clientdata.html`): クライアントプロフィールと過去セッション管理。
  - **セッション完了画面** (`finish.html`): 要約確定とメール送信。

## セッション完了画面 (`finish.html`)
- 最新セッションの要約とフィードバックを表示・編集。
- 「メール送信」ボタンで要約をパスワード付きPDFに変換し、サーバー(`https://ep.robo-aica.com/send_email.php`)へ送信してクライアントへ配布する。

## PDF生成
- `pdf-lib`と`fontkit`を使い日本語フォントを埋め込み、フッターにロゴと"generated by AICA"の文字列を描画する。
- `node-qpdf2`でクライアントごとのパスワードを設定して暗号化し、一時ファイルを削除した後に最終ファイルを保存する。

## Preload API
`preload.js`はレンダラープロセスに以下の機能を公開する：
- HTML画面の切替とデータ引き継ぎ。
- XMLおよびセッションファイルの読み書き。
- PDFの作成とメール送信。
- 使用中の音声認識サービスの取得と開始・停止イベントの監視。

## 技術スタック
- Electron
- pdf-lib / node-qpdf2
- axios / FormData
- @xmldom/xmldom
- socket.io / WebSocket

## エラーハンドリングとログ
- メインプロセスは`app.log`にログを記録し、XML操作・PDF生成・サーバー通信でエラーが発生した場合はダイアログやアラートで通知する。
