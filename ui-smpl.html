<!-- 途中：
Userの選択→xmlの更新 未作成
prompt読み込まなくなったので、不要なものが色々残ってる。 -->
<!-- @01. 追加修正 2024.10.28 traetal.systems -->
<!-- @02. local音声サーバーからの受信に変更 2025.04.03 traetal.systems -->
<!-- @03. @02に伴い、zoom Meeting IDの廃止 2025.07.31 traetal.systems -->

<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8"><!--@01a-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"><!--@01a-->
  <link rel="stylesheet" type="text/css" href="styles-smpl.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!--@01a-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!--@02d <script src="./socket.io.js"></script> -->

</head>

<body>
  <div class="container">
    <div class="left-section">
      <div class="display-area" id="display-area1">
        <p>要約</p>
        <textarea class="display-area" id="summaryArea"></textarea>
      </div>
      <div class="display-area" id="display-area2">
        <p>リアルタイム文字起こし</p>
        <textarea class="display-area" id="transcriprionArea"></textarea>
      </div>
    </div>
    <div class="center-section">
      <div id="clientSelect">
        <label for="clientDropdown">クライアント:</label>
        <select id="clientDropdown" onchange="setSelectedClient()">
          <option value="">クライアントを選択してセッションを開始する</option>
        </select>
      </div>
      <div class="question-header">
        <img src="robo-aica.png" alt="ロボット" class="icon">
        <span>こんな質問はいかが？</span>
      </div>
      <div class="display-area" id="exampleQuestions">
        <div id="exampleQuestionsList">
          <!--<p>例: この課題についての詳細は？</p>-->
          <!--<p>例: 他に解決策はありますか？</p>-->
        </div>
      </div>
      <div class="question-header">
        <img src="robo-aica.png" alt="ロボット" class="icon">
        <span>AICAとのチャット</span>
      </div>

      <div class="display-area" id="chatArea">
        <button id="reGenerateButton" class="chat-regenerate-button">
          <i class="fa-solid fa-repeat"></i>
        </button>
      </div>
      <div id="inputButtonArea">
        <div class="top-buttons">
          <button id="transcriptionControl" class="transcription-control" data-state="disabled" disabled>
            <div class="control-content">
              <div class="status-indicator"></div>
              <span class="control-text">文字起こし準備中</span>
              <i class="control-icon fa-solid fa-microphone-slash"></i>
            </div>
          </button>
          <button id="topicResetButton">話題リセット</button>
          <!-- <button id="feedback">セッション完了 振り返り</button> -->
        </div>
        <!--<p>AICA 1クリックアドバイス</p>-->
        <div class="button-group">
          <button id="solution" contenteditable="true">解決策</button>
          <button id="aspect" contenteditable="true">その他の視点</button>
          <button id="uplift" contenteditable="true">心を軽くするには？</button>
          <button id="questionNow" contenteditable="true">いますべき質問</button>
        </div>
        <div id="freeInputArea">
          <!--<p>AICAへの質問入力</p>-->
          <!-- <textarea id="inputFI-0" class="inputFI" style="display: none;"></textarea>
              <textarea id="inputFI-1" class="inputFI" style="display: none;"></textarea>
              <textarea id="inputFI-2" class="inputFI" style="display: none;"></textarea>
              <textarea id="inputFI-3" class="inputFI" style="display: none;"></textarea> -->
          <textarea id="inputFIFoot" class="inputFI"></textarea>
          <button id="freeInputButton" class="input-send-button"><i class="fa-solid fa-angles-up"></i></button>
        </div>
        <!-- ↓画面切り替え -->
        <div class="bottom-buttons" id="switch">
          <button id="switch-btn-userdata">マイページへ</button>
          <button id="switch-btn-clientdata">クライアントデータ編集画面へ</button>
          <button id="switch-btn-finish">セッション完了時用画面へ</button>
        </div>
      </div>
    </div>
    <div class="right-section">
    </div>
  </div>
  <div id="bottom">
  </div>

  <script src="common.js"></script>
  <script>
    // localStorageからAICADataを復元（XMLデータ以外）
    console.log('=== STARTING UI-SMPL RESTORATION ===');
    const uiStoredData = localStorage.getItem('AICAData');
    console.log('Raw localStorage data:', uiStoredData);
    if (uiStoredData) {
      try {
        const restoredData = JSON.parse(uiStoredData);
        console.log('Parsed localStorage data:', restoredData);
        console.log('uiChatContent from localStorage:', restoredData.uiChatContent);
        console.log('uiExampleQuestions from localStorage:', restoredData.uiExampleQuestions);
        
        // XMLデータ以外の状態を復元
        window.AICAData = window.AICAData || {};
        window.AICAData.selectedClient = restoredData.selectedClient || "";
        window.AICAData.selectedSession = restoredData.selectedSession || "";
        window.AICAData.userName = restoredData.userName || "";
        window.AICAData.userEmail = restoredData.userEmail || "";
        window.AICAData.userProfile = restoredData.userProfile || "";
        window.AICAData.clientInfo = restoredData.clientInfo || {};
        window.AICAData.allTranscription = restoredData.allTranscription || "";
        window.AICAData.mainTranscription = restoredData.mainTranscription || "";
        window.AICAData.conversation_history = restoredData.conversation_history || [];
        window.AICAData.uiChatContent = restoredData.uiChatContent || [];
        window.AICAData.uiExampleQuestions = restoredData.uiExampleQuestions || "";
        window.AICAData.currentIChatCount = restoredData.currentIChatCount || 0;
        console.log('AICAData状態復元完了（XMLデータ除く）');
        console.log('Final AICAData.uiChatContent:', window.AICAData.uiChatContent);
        console.log('Final AICAData.uiExampleQuestions:', window.AICAData.uiExampleQuestions);
        console.log('Final AICAData.currentIChatCount:', window.AICAData.currentIChatCount);
      } catch (e) {
        console.error('Failed to parse AICAData from localStorage:', e);
        // 復元に失敗した場合は初期化
        window.AICAData = window.AICAData || {};
      }
    } else {
      console.log('No localStorage data found');
      // localStorageにデータがない場合は初期化
      window.AICAData = window.AICAData || {};
    }

    // サーバーのURLとパスを指定して接続します
    //@02d const soc = io.connect('https://robo-aica.com');
    //@01d const roomId = prompt("Please enter your Meeting ID:");
    //@01m.start

    // メッセージIDとメッセージ内容のマッピングを保持するオブジェクト
    const messages = {}; //テスト用に一時的にコメントアウトにしている

    const transcriptionControl = document.getElementById('transcriptionControl');
    const controlText = transcriptionControl.querySelector('.control-text');
    const controlIcon = transcriptionControl.querySelector('.control-icon');
    let speechServiceRunning = false;
    let startCheckTimer = null;
    window.isRunning = false;

    function updateTranscriptionControl(state) {
      // Remove all existing state classes and animations
      transcriptionControl.setAttribute('data-state', state);
      
      switch(state) {
        case 'disabled':
          controlText.textContent = '文字起こし準備中';
          controlIcon.className = 'control-icon fa-solid fa-microphone-slash';
          transcriptionControl.disabled = true;
          break;
          
        case 'stopped':
          controlText.textContent = '文字起こし開始';
          controlIcon.className = 'control-icon fa-solid fa-microphone';
          transcriptionControl.disabled = false;
          break;
          
        case 'starting':
          controlText.textContent = '起動中...';
          controlIcon.className = 'control-icon fa-solid fa-spinner';
          transcriptionControl.disabled = true;
          break;
          
        case 'running':
          controlText.textContent = '文字起こし停止';
          controlIcon.className = 'control-icon fa-solid fa-stop';
          transcriptionControl.disabled = false;
          break;
          
        case 'warning':
          controlText.textContent = '接続エラー - 再試行';
          controlIcon.className = 'control-icon fa-solid fa-exclamation-triangle';
          transcriptionControl.disabled = false;
          break;
      }
    }

    updateTranscriptionControl('disabled');

    transcriptionControl.addEventListener('click', handleTranscriptionControlClick);

    function handleTranscriptionControlClick() {
      const currentState = transcriptionControl.getAttribute('data-state');
      
      if (currentState === 'stopped' || currentState === 'warning') {
        startTranscription();
      } else if (currentState === 'running') {
        stopTranscription();
      }
      // disabled and starting states are non-interactive
    }

    async function startTranscription() {
      if (window.isRunning) return;
      
      // クライアントが選択されているかチェック
      if (!window.AICAData.selectedClient || window.AICAData.selectedClient === "") {
        alert("クライアントを選択してください。");
        return;
      }
      
      // 選択されたクライアント名を取得
      const clients = AICAData.xmlData.getElementsByTagName("Client");
      const selectedClientIndex = parseInt(window.AICAData.selectedClient);
      if (!clients[selectedClientIndex]) {
        alert("選択されたクライアントが見つかりません。");
        return;
      }
      
      const clientNameElement = clients[selectedClientIndex].getElementsByTagName("ClientName")[0];
      const clientName = clientNameElement ? clientNameElement.textContent : "不明なクライアント";
      
      // 確認ダイアログを表示
      const confirmMessage = `${clientName}との会話文字起こしを開始します。\n\nよろしいですか？`;
      const userConfirmed = confirm(confirmMessage);
      
      if (!userConfirmed) {
        console.log('文字起こし開始がキャンセルされました');
        return;
      }
      
      console.log(`文字起こし開始確認: ${clientName}`);
      
      // 1時間以上経過している場合は新セッション開始（チャット履歴クリア）
      if (shouldStartNewSession()) {
        console.log('Starting new session due to 1+ hour gap');
        await startNewSession();
      } else {
        console.log('Continuing existing session');
      }
      
      addNewSession();
      constantSaveTranscription();
      window.isRunning = true;
      updateTranscriptionControl('starting');
      speechServiceRunning = false;
      window.electronAPI.startSpeechRecognition();
      startCheckTimer = setTimeout(() => {
        if (!speechServiceRunning) {
          updateTranscriptionControl('warning');
        }
      }, 3000);
    }

    function stopTranscription() {
      if (!window.isRunning) return;
      window.isRunning = false;
      window.electronAPI.stopSpeechRecognition();
      updateTranscriptionControl('stopped');
    }

    window.electronAPI.onSpeechRecognitionStatus(data => {
      if (data.status === 'started') {
        speechServiceRunning = true;
        updateTranscriptionControl('running');
        if (startCheckTimer) clearTimeout(startCheckTimer);
      } else if (data.status === 'stopped') {
        speechServiceRunning = false;
        if (window.isRunning) {
          updateTranscriptionControl('warning');
        } else {
          updateTranscriptionControl('stopped');
        }
        if (startCheckTimer) clearTimeout(startCheckTimer);
      }
    });

    //
    // WebSocketサーバーの URL（C# 側で起動している wsServer のエンドポイント）
    const ws = new WebSocket("ws://localhost:8181/ws/");

    ws.onopen = () => {
      console.log("WebSocket connection established");
    };

    ws.onmessage = (event) => {
      console.log("Received message:", event.data);
      try {
        // 受信した JSON をパース
        const data = JSON.parse(event.data);
        const messageId = data.msg_id;
        const userName = data.usr_name;
        const content = data.content;

        // メッセージのマッピングを更新
        messages[messageId] = { userName, content };

        // 表示内容を更新する関数（既存の updateDisplay() を利用）
        updateDisplay();
      } catch (e) {
        console.error("Error parsing message:", e);
      }
    };

    ws.onerror = (error) => {
      console.error("WebSocket error:", error);
    };

    ws.onclose = () => {
      console.log("WebSocket connection closed");
    };

    //@03dfunction checkRoomId() {
    //@03d  if (typeof window.AICAData.roomId === 'string') {
    //@03d    let roomId = window.AICAData.roomId;
    //@03d    console.log("roonId:" + roomId);
    //@03d    soc.emit('join room', roomId);
    //@03d  } else {
    //@03d    console.log("roonIdを新規指定する必要があります");
    //@03d    (async () => {
    //@03d      let roomId = await window.electronAPI.showMeetingIdPrompt();
    //@03d      roomId = roomId.replace(/ /g, "");
    //@03d      if (roomId) {
    //@03d        console.log("roomId=", roomId);
    //@03d        //@02d soc.emit('join room', roomId);
    //@03d        window.AICAData.roomId = roomId;
    //@03d      }
    //@03d      else {
    //@03d        alert("You must enter a Meeting ID to proceed.");
    //@03d        location.reload();
    //@03d      }
    //@03d    })(); //@01m.finish
    //@03d  }
    //@03d}

    function updateDisplay() {
      // messagesオブジェクトの内容に基づいて表示を更新
      const displayArea = document.getElementById('display-area2');
      displayArea.innerHTML = ''; // 表示内容を初期化

      for (const { userName, content } of Object.values(messages)) {
        // 各メッセージのユーザー名とメッセージ内容を表示
        const messageElement = document.createElement('div');
        messageElement.textContent = `${userName}: ${content}`;
        displayArea.appendChild(messageElement);
      }
      displayArea.scrollTop = displayArea.scrollHeight;
    }

    window.currentHtml = "ui-smpl";
    window.isRestoringFromScreenTransition = true; // 画面復帰フラグ
    
    // UI内容を復元する関数
    function restoreUIContent() {
      console.log('=== RESTORE UI CONTENT CALLED ===');
      console.log('Full AICAData:', window.AICAData);
      console.log('uiChatContent:', window.AICAData.uiChatContent);
      console.log('conversation_history:', window.AICAData.conversation_history);
      console.log('uiExampleQuestions:', window.AICAData.uiExampleQuestions);
      
      // ChatArea要素が存在するか確認
      const chatArea = document.getElementById('chatArea');
      console.log('chatArea element:', chatArea);
      if (chatArea) {
        console.log('chatArea current content:', chatArea.innerHTML.length, 'chars');
      }
      
      // チャット内容の復元 - まずuiChatContentから試行
      let chatRestored = false;
      
      if (window.AICAData.uiChatContent && window.AICAData.uiChatContent.length > 0) {
        console.log('Restoring from uiChatContent, items count:', window.AICAData.uiChatContent.length);
        const chatArea = document.getElementById('chatArea');
        if (chatArea) {
          // 既存の再生成ボタン以外をクリア
          const regenerateButton = chatArea.querySelector('#reGenerateButton');
          chatArea.innerHTML = '';
          if (regenerateButton) {
            chatArea.appendChild(regenerateButton);
          }
          
          // チャット内容を復元
          window.AICAData.uiChatContent.forEach((chatItem, index) => {
            console.log(`Restoring uiChat item ${index}:`, chatItem);
            const textarea = document.createElement('textarea');
            textarea.readOnly = true;
            textarea.value = chatItem.content;
            textarea.setAttribute('rows', '1');
            textarea.className = chatItem.classes;
            chatArea.appendChild(textarea);
            
            // 高さ調整
            if (typeof adjustTextareaHeight === 'function') {
              adjustTextareaHeight(textarea);
            } else {
              textarea.style.height = 'auto';
              textarea.style.height = textarea.scrollHeight + 'px';
            }
          });
          
          console.log('チャット内容をuiChatContentから復元しました');
          chatRestored = true;
        } else {
          console.error('chatArea element not found');
        }
      }
      
      // uiChatContentが無い場合、conversation_historyから復元
      if (!chatRestored && window.AICAData.conversation_history && window.AICAData.conversation_history.length > 0) {
        console.log('Restoring from conversation_history, items count:', window.AICAData.conversation_history.length);
        const chatArea = document.getElementById('chatArea');
        if (chatArea) {
          // 既存の再生成ボタン以外をクリア
          const regenerateButton = chatArea.querySelector('#reGenerateButton');
          chatArea.innerHTML = '';
          if (regenerateButton) {
            chatArea.appendChild(regenerateButton);
          }
          
          // conversation_historyから復元
          window.AICAData.conversation_history.forEach((historyItem, index) => {
            console.log(`Restoring conversation item ${index}:`, historyItem);
            const textarea = document.createElement('textarea');
            textarea.readOnly = true;
            textarea.value = historyItem.content;
            textarea.setAttribute('rows', '1');
            
            // roleに応じてクラスを設定
            if (historyItem.role === 'user') {
              textarea.className = `User ${Math.floor(index / 2) + 1}`;
            } else if (historyItem.role === 'assistant') {
              textarea.className = `AI ${Math.floor(index / 2) + 1}`;
            }
            
            chatArea.appendChild(textarea);
            
            // 高さ調整
            if (typeof adjustTextareaHeight === 'function') {
              adjustTextareaHeight(textarea);
            } else {
              textarea.style.height = 'auto';
              textarea.style.height = textarea.scrollHeight + 'px';
            }
          });
          
          console.log('チャット内容をconversation_historyから復元しました');
          chatRestored = true;
        } else {
          console.error('chatArea element not found');
        }
      }
      
      if (!chatRestored) {
        console.log('No chat content to restore from either source');
      }
      
      // 質問提案内容の復元
      if (window.AICAData.uiExampleQuestions) {
        const exampleQuestions = document.getElementById('exampleQuestionsList');
        if (exampleQuestions) {
          exampleQuestions.innerHTML = window.AICAData.uiExampleQuestions; // textContentからinnerHTMLに変更
          console.log('質問提案内容を復元しました');
        } else {
          console.error('exampleQuestionsList element not found');
        }
      } else {
        console.log('No example questions to restore');
      }
    }

    // DOM完全ロード後にUI復元処理を実行
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOMContentLoaded - checking if UI restoration needed');
      
      // XMLデータをロード（関数が定義されているか確認）
      if (typeof loadXMLData === 'function') {
          console.log('loadXMLData関数確認完了 - XMLデータロード開始');
          loadXMLData(() => {
            populateClientDropdown();
            
            // メイン画面での選択クライアントを復元（編集画面での変更は無視）
            if (typeof loadMainScreenSelectedClient === 'function') {
              const mainScreenClient = loadMainScreenSelectedClient();
              if (mainScreenClient !== "") {
                const clientDropdown = document.getElementById('clientDropdown');
                if (clientDropdown) {
                  console.log('メイン画面復元: 編集画面の選択は無視して、メイン画面の選択を復元:', mainScreenClient);
                  // onchangeイベントを発火させずに値を設定
                  const originalOnchange = clientDropdown.onchange;
                  clientDropdown.onchange = null;
                  clientDropdown.value = mainScreenClient;
                  clientDropdown.onchange = originalOnchange;
                  console.log('メイン画面の選択を復元完了:', clientDropdown.value);
                  
                  // AICAData.selectedClientも更新（整合性を保つため）
                  window.AICAData.selectedClient = mainScreenClient;
                  
                  // メイン画面での選択をXMLに再保存（編集画面での変更を上書き）
                  if (typeof saveMainScreenSelectedClient === 'function') {
                    saveMainScreenSelectedClient();
                  }
                } else {
                  console.error('clientDropdown not found for restoration');
                }
              } else {
                console.log('No main screen client selection to restore');
              }
            } else {
              console.error('loadMainScreenSelectedClient function not found');
            }
            
            // UI復元は保存されたチャット内容が存在する場合のみ実行
            const hasUIContentToRestore = (window.AICAData.uiChatContent && window.AICAData.uiChatContent.length > 0) ||
                                         (window.AICAData.conversation_history && window.AICAData.conversation_history.length > 0) ||
                                         (window.AICAData.uiExampleQuestions);
            
            console.log('Has UI content to restore:', hasUIContentToRestore);
            console.log('- uiChatContent:', window.AICAData.uiChatContent ? window.AICAData.uiChatContent.length : 0);
            console.log('- conversation_history:', window.AICAData.conversation_history ? window.AICAData.conversation_history.length : 0);
            console.log('- uiExampleQuestions:', !!window.AICAData.uiExampleQuestions);
            
            if (hasUIContentToRestore) {
              console.log('Restoring UI content from previous screen transition');
              // DOM要素がロードされた後に復元処理を実行
              setTimeout(() => {
                restoreUIContent();
                // 復元完了後の確認とフラグリセット
                setTimeout(() => {
                  console.log('=== POST-RESTORATION CHECK ===');
                  const chatArea = document.getElementById('chatArea');
                  if (chatArea) {
                    const textareas = chatArea.querySelectorAll('textarea');
                    console.log('ChatArea textareas after restoration:', textareas.length);
                    textareas.forEach((textarea, index) => {
                      console.log(`Textarea ${index}: classes="${textarea.className}", value="${textarea.value.substring(0, 50)}..."`);
                    });
                    console.log('Final chatArea HTML:', chatArea.innerHTML.substring(0, 200) + '...');
                  } else {
                    console.error('chatArea not found in post-restoration check');
                  }
                  const exampleQuestions = document.getElementById('exampleQuestionsList');
                  if (exampleQuestions) {
                    console.log('ExampleQuestions content after restoration:', exampleQuestions.innerHTML);
                  }
                  // フラグを少し遅れてリセット
                  window.isRestoringFromScreenTransition = false;
                  console.log('=== RESTORATION PROCESS COMPLETED ===');
                }, 50);
              }, 100);
            } else {
              console.log('No UI content to restore - this is likely a fresh start');
              window.isRestoringFromScreenTransition = false;
            }
          });
      } else {
          console.error('loadXMLData関数が見つかりません');
          setTimeout(() => {
              if (typeof loadXMLData === 'function') {
                  console.log('遅延ロード: XMLデータロード開始');
                  loadXMLData(() => {
                    populateClientDropdown();
                    
                    // メイン画面での選択クライアントを復元（編集画面での変更は無視）
                    if (typeof loadMainScreenSelectedClient === 'function') {
                      const mainScreenClient = loadMainScreenSelectedClient();
                      if (mainScreenClient !== "") {
                        const clientDropdown = document.getElementById('clientDropdown');
                        if (clientDropdown) {
                          console.log('遅延ロード: メイン画面復元, 編集画面選択は無視:', mainScreenClient);
                          // onchangeイベントを発火させずに値を設定
                          const originalOnchange = clientDropdown.onchange;
                          clientDropdown.onchange = null;
                          clientDropdown.value = mainScreenClient;
                          clientDropdown.onchange = originalOnchange;
                          console.log('遅延ロード: メイン画面選択復元完了:', clientDropdown.value);
                          
                          // AICAData.selectedClientも更新（整合性を保つため）
                          window.AICAData.selectedClient = mainScreenClient;
                          
                          // メイン画面での選択をXMLに再保存（編集画面での変更を上書き）
                          if (typeof saveMainScreenSelectedClient === 'function') {
                            saveMainScreenSelectedClient();
                          }
                        } else {
                          console.error('遅延ロード: clientDropdown not found for restoration');
                        }
                      } else {
                        console.log('遅延ロード: No main screen client selection to restore');
                      }
                    } else {
                      console.error('遅延ロード: loadMainScreenSelectedClient function not found');
                    }
                    
                    // UI復元は保存されたチャット内容が存在する場合のみ実行
                    const hasUIContentToRestore = (window.AICAData.uiChatContent && window.AICAData.uiChatContent.length > 0) ||
                                                 (window.AICAData.conversation_history && window.AICAData.conversation_history.length > 0) ||
                                                 (window.AICAData.uiExampleQuestions);
                    
                    if (hasUIContentToRestore) {
                      console.log('遅延ロード: Restoring UI content from previous screen transition');
                      setTimeout(() => {
                        restoreUIContent();
                        // 復元完了後の確認とフラグリセット
                        setTimeout(() => {
                          console.log('=== POST-RESTORATION CHECK (DELAYED) ===');
                          const chatArea = document.getElementById('chatArea');
                          if (chatArea) {
                            const textareas = chatArea.querySelectorAll('textarea');
                            console.log('ChatArea textareas after delayed restoration:', textareas.length);
                          }
                          // フラグを少し遅れてリセット
                          window.isRestoringFromScreenTransition = false;
                        }, 50);
                      }, 100);
                    } else {
                      console.log('遅延ロード: No UI content to restore - this is likely a fresh start');
                      window.isRestoringFromScreenTransition = false;
                    }
                  });
              } else {
                  console.error('loadXMLData関数が依然として見つかりません');
                  window.isRestoringFromScreenTransition = false;
              }
          }, 100);
      }
    });
    
    // 前のセッションから1時間以上経過しているかチェック
    function shouldStartNewSession() {
      if (!window.AICAData.selectedClient || window.AICAData.selectedClient === "") {
        return false; // クライアントが選択されていない場合は新セッション不要
      }
      
      try {
        const clients = AICAData.xmlData.getElementsByTagName("Client");
        const client = clients[window.AICAData.selectedClient];
        if (!client) return true; // クライアントが見つからない場合は新セッション開始
        
        const sessions = client.getElementsByTagName("Session");
        if (sessions.length === 0) return true; // セッションが無い場合は新セッション開始
        
        // 最新セッションの日時を取得
        const lastSession = sessions[sessions.length - 1];
        const lastDateTime = lastSession.getElementsByTagName("DateTime")[0];
        if (!lastDateTime) return true;
        
        const lastSessionTime = new Date(lastDateTime.textContent);
        const currentTime = new Date();
        const hoursDiff = (currentTime - lastSessionTime) / (1000 * 60 * 60);
        
        console.log(`Last session: ${lastSessionTime}, Current: ${currentTime}, Hours diff: ${hoursDiff}`);
        
        return hoursDiff >= 1; // 1時間以上経過していればtrue
      } catch (error) {
        console.error('Error checking session time:', error);
        return true; // エラーの場合は新セッション開始
      }
    }

    // 新しいセッションを開始（チャット履歴をクリア）
    async function startNewSession() {
      console.log("startNewSession called - clearing chat history for new session");
      
      if (window.isRunning) {
        stopTranscription();
      }
      await deleteEmptySession();
      window.isRunning = false;
      
      // チャット履歴とUI表示をクリア
      const chatArea = document.getElementById('chatArea');
      if (chatArea) {
        const regenerateButton = chatArea.querySelector('#reGenerateButton');
        chatArea.innerHTML = '';
        if (regenerateButton) {
          chatArea.appendChild(regenerateButton);
        }
      }
      
      const exampleQuestions = document.getElementById('exampleQuestionsList');
      if (exampleQuestions) {
        exampleQuestions.innerHTML = '';
      }
      
      // グローバル変数もクリア
      window.AICAData.conversation_history = [];
      window.AICAData.uiChatContent = [];
      window.AICAData.uiExampleQuestions = "";
      window.AICAData.currentIChatCount = 0;
      
      // transcript-processor.jsのiChatカウンターもリセット
      if (typeof iChat !== 'undefined') {
        iChat = 0;
        console.log('Reset iChat counter to 0 for new session');
      }
      
      console.log('startNewSession: Cleared all chat data for new client');
      
      setSelectedClient();
      updateTranscriptionControl('stopped');
    }


    // 自由入力欄エンターキーで送信
    document.addEventListener('DOMContentLoaded', function () {
      var textarea = document.getElementById('inputFIFoot');
      var button = document.getElementById('freeInputButton');

      var isComposing = false; // 日本語入力の変換中かどうかを判断する変数

      textarea.addEventListener('compositionstart', function () {
        isComposing = true; // 変換開始
      });

      textarea.addEventListener('compositionend', function () {
        isComposing = false; // 変換終了
      });

      textarea.addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !isComposing) {
          if (event.shiftKey) {
            // Shift + Enterで改行
            return;
          } else {
            // Enterのみでボタンが押される
            event.preventDefault();
            button.click();
          }
        }
      });
    });



    document.getElementById('switch-btn-userdata').addEventListener('click', () => {
      switchTo('renew_userdata.html');
    });
    document.getElementById('switch-btn-clientdata').addEventListener('click', () => {
      switchTo('renew_clientdata.html');
    });
    document.getElementById('switch-btn-finish').addEventListener('click', () => {
      switchTo('finish.html');
    });

    function switchTo(htmlFileName) {
      deleteEmptySession();
      const dataToSave = dataToSwitch();
      console.log('=== SWITCHING TO ===', htmlFileName);
      console.log('Data being saved to localStorage:', dataToSave);
      console.log('uiChatContent being saved:', dataToSave.uiChatContent);
      console.log('uiExampleQuestions being saved:', dataToSave.uiExampleQuestions);
      localStorage.setItem('AICAData', JSON.stringify(dataToSave));
      console.log('Data saved to localStorage successfully');
      window.electronAPI.switchHtml(htmlFileName);
    }

    // 確実にチャット履歴を保存する関数
    function saveConversationHistory() {
      const textareas = document.querySelectorAll('#chatArea textarea');
      const conversationHistory = [];
      
      textareas.forEach(textarea => {
        // regenerateButtonは除外
        if (textarea.id === 'reGenerateButton') return;
        
        let role = null;
        if (textarea.classList.contains('User')) {
          role = 'user';
        } else if (textarea.classList.contains('AI')) {
          role = 'assistant';
        }
        
        if (role && textarea.value.trim()) {
          conversationHistory.push({
            role: role,
            content: textarea.value.trim()
          });
        }
      });
      
      console.log('saveConversationHistory found items:', conversationHistory.length);
      console.log('saveConversationHistory result:', conversationHistory);
      return conversationHistory;
    }

    function dataToSwitch() {
      console.log('dataToSwitch called');
      window.AICAData.allTranscription = getTranscription("all");
      window.AICAData.mainTranscription = getTranscription("main");
      
      // メイン画面での選択クライアントを保存（XMLに永続化）
      if (typeof saveMainScreenSelectedClient === 'function') {
        saveMainScreenSelectedClient();
      } else {
        console.error('saveMainScreenSelectedClient function not found');
      }
      
      // チャット履歴を確実に保存
      window.AICAData.conversation_history = saveConversationHistory();
      
      // UIレベルでのチャット内容を保存
      const chatArea = document.getElementById('chatArea');
      if (chatArea) {
        const chatContent = [];
        const textareas = chatArea.querySelectorAll('textarea');
        console.log('Found textareas in chatArea:', textareas.length);
        textareas.forEach((textarea, index) => {
          console.log(`Textarea ${index} classes:`, Array.from(textarea.classList));
          console.log(`Textarea ${index} value:`, textarea.value.substring(0, 50) + '...');
          if (textarea.classList.contains('User') || textarea.classList.contains('AI')) {
            chatContent.push({
              type: textarea.classList.contains('User') ? 'user' : 'ai',
              content: textarea.value,
              classes: Array.from(textarea.classList).join(' ')
            });
          }
        });
        window.AICAData.uiChatContent = chatContent;
        console.log('Saved chat content items:', chatContent.length);
        console.log('Chat content:', chatContent);
      } else {
        console.error('chatArea not found during save');
      }
      
      // iChatカウンターも保存（transcript-processor.jsのグローバル変数）
      if (typeof iChat !== 'undefined') {
        window.AICAData.currentIChatCount = iChat;
        console.log('Saved iChat counter:', iChat);
      } else {
        console.log('iChat variable not accessible from ui-smpl.html');
      }
      
      // 質問提案の内容を保存
      const exampleQuestions = document.getElementById('exampleQuestionsList');
      if (exampleQuestions) {
        window.AICAData.uiExampleQuestions = exampleQuestions.innerHTML; // textContentからinnerHTMLに変更
        console.log('Saved example questions:', exampleQuestions.innerHTML);
      } else {
        console.error('exampleQuestionsList not found during save');
      }
      
      const serializedData = serializeAICAData(window.AICAData);
      console.log('Serialized data keys:', Object.keys(serializedData));
      return serializedData;
    }

  </script>
  <script src="./transcript-processor.js"></script>
  <script>
    // transcript-processor.js読み込み後のデータ確認
    console.log('=== AFTER TRANSCRIPT-PROCESSOR.JS LOADED ===');
    console.log('AICAData.uiChatContent after script load:', window.AICAData.uiChatContent);
    console.log('AICAData.uiExampleQuestions after script load:', window.AICAData.uiExampleQuestions);
  </script>
</body>

</html>